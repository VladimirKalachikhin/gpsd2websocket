[In English](README.md)  
# gpsd2websocket  [![License: CC BY-NC-SA 4.0](Cc-by-nc-sa_icon.svg)](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en)
**version 0**

Доступ к данным **[gpsd](https://gpsd.io/)** через websocket.  
Основная цель проекта - облегчить использование данных Глобальных Навигационных Спутниковых Систем в веб-приложениях. Веб приложению не нужно заботиться об актуальности данных или отслеживать потерю датчиков - оно получает только надёжную информаию.  
**gpsd2websocket** - это легковесный прокси-сервер, написанный на чистом PHP без использования сторонних библиотек. Сервер работает на любой платформе, где есть базовая реализация PHP, и очень нетребователен к ресурсам.

## Возможности
* **gpsd2websocket** взаимодействует с выполняющемся **gpsd** обычным для него способом, поэтому **gpsd** может быть запущен тем способом и с теми параметрами, какие требуются. 
* Пользовательское приложение может подключаться к **gpsd2websocket** как по протоколу websocket, так и по протоколу tcp socket.
* Пользовательское приложение может получать от **gpsd2websocket** данные только требуемых классов **gpsd**.
* Пользовательское приложение может не получать данные указанных классов **gpsd** от определённых устройств.
* Пользовательское приложение не обязано следовать какому-то протоколу соединения с **gpsd2websocket** и может быть упрощённым: для получения данных достаточно подключиться.
* Тем не менее, пользовательское приложение может указать **gpsd2websocket**, какие данные оно желает получать и каким образом.
* Может быть запущено любое количество экземпляров **gpsd2websocket**, каждый со своими параметрами.


## Демо
Простйшее веб-приложение, показывающее положение на карте, находится в [demo/](demo/)

На одной и той же машине:
* Запустите **gpsd** с реальным приёмником ГНСС, или с [симулятором](https://github.com/panaaj/nmeasimulator).
* Запустите `php gpsd2websocket.php`
* Откройте файл `demo/index.html` в браузере.


## Установка
Просто скопируйте файлы `gpsd2websocket.php` и `fCommon.php` в желаемое место. При необходимости скопируйте и измените `params.php`.


## Использование
### Запуск
`php gpsd2websocket.php [--params=params.php] [any parameters]`  
При запуске без параметров, все параметры берутся из файла `params.php`, если он имеется.  
Можно указать в параметрах запуска собственный файл параметров. Кроме того, любые параметры можно указать в строке запуска. Параметры, указанные в строке запуска, имеют преимущество перед теми же параметрами из файла параметров.  
Параметры:  
--params=params.php  Файл параметров. По умолчанию params.php  
--gpsdProxyHost=host  Имя хоста для подключения к **gpsd2websocket**. В случае указания адреса ipv6 квадратные скобки [] обязательны. По умолчанию [::]  
--gpsdProxyPort=port  Порт для подключению к **gpsd2websocket**. По умолчанию 3839.  
--dataSourceHost=host  Имя хоста **gpsd**. По умолчанию localhost.  
--dataSourcePort=port Порт **gpsd**. По умолчанию 2947, умолчальный порт **gpsd**.  
--gpsdProxyTimeouts="{json string}"  Время жизни данных **gpsd**, по истечении которого считается, что данные неактуальны. Умолчальные значения см. в `params.php`.  
--dontUseDevices="{json string}"  Список устройств **gpsd**, данные указанных классов от которых следует игнорировать. Например: {"TPV":["tcp://192.168.10.10:3800"],"AIS":[gpsd://192.168.10.10:2947#tcp://localhost:2222]}. ПО умолчанию пусто.  
--defaultSubscribe="TPV,ATT"  Список классов **gpsd**, данные которых будут отдаваться клиентам. Весь список: TPV, ATT, SKY, TOFF, PPS, OSC, AIS. По умолчанию "TPV,ATT".  
--boatInfo="{json string}"  Некоторые характеристики судна для возможного исправления некоторых величин. По умолчанию пусто  
--noClientTimeout=30  sec., Пауза перед отключением от **gpsd** при отсутствии клиентов. 0 для предотвращения отключения. По умолчанию 30 сек.  
--noRealTime="AIS,SKY"  Список классов **gpsd**, изменения в данных которых не обязательно передавать клиенту немедленно. Данные будут переданы по завершению приёма всех изменений. По умолчанию "AIS,SKY".  
-h --help  краткая подсказка

## Подключение
Клиентское приложение должно подключаться к **gpsd2websocket** по протоколу websocket [обычным способом](https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API):
```
let webSocket = new WebSocket("ws://"+gpsdProxyHost+":"+gpsdProxyPort);

webSocket.onopen = ...

webSocket.onmessage = ...

webSocket.onclose = ...

webSocket.onerror = ...
```
, см. пример кода [demo/index.html](demo/index.html).  
Сразу после подключения клиентская программа начнёт получать данные в соответствии с конфигурацией **gpsd2websocket**.  
Если же подключиться по протоколу tcp socket, то для начала получения данных клиентская программа должна послать `\n\n`.

## Формат данных
**gpsd2websocket** присылает данные в формате JSON как это описано в [документации к gpsd](https://gpsd.io/gpsd_json.html) для режима {"scaled";true,"split24":true}, за исключением следующего:
* Все данные, включая данные AIS, представлены в единицах измерения СИ:
>* Скорость в м/сек
>* Географическое положение в десятичных градусах
>* Углы в градусах
>* Осадка в метрах
>* Длина в метрах
>* Ширина в метрах
* Неопределённые величины, включая данные AIS, имеют значение __null__
* Поле 'second' отсутствует, но есть 'timestamp' как unix time
* В данных класса TPV нет величины 'depth', вместо этого она находится в классе ATT
* В данных класса TPV нет величины 'temp', вместо этого она находится в классе ATT
* В данных класса TPV нет всех данных о ветре, эти данные находятся в классе ATT
* В данных класса TPV нет величины 'wtemp', вместо этого она находится в классе ATT
* Класс AIS содержит:
```
{"class":"AIS",
"ais":{
	"vessel_mmsi":{
		...
		vessel data
		...
```
В целом, формат отдаваемых данных аналогичен таковому в [gpsdPROXY](https://github.com/VladimirKalachikhin/gpsdPROXY).

## Управление данными
Клиенствкая программа может отсылать **gpsd2websocket** команды, аналогичные [командам gpsd](https://gpsd.io/gpsd_json.html#_core_protocol_commands), для указания требуемых данных:
**?DEVICES;** возвращает список устройств **gpsd**  
**?WATCH={};** требует от **gpsd2websocket** прекратит или продолжить слать данные, а также устанавливает состав и условия получения этих данных путём указания параметров команды, в формате JSON. Параметры могут быть следующие:  

> "subscribe" - указывает, данные какиех классов **gpsd** клиентскаая программа желает получать. Список классов: TPV, ATT, SKY, TOFF, PPS, OSC, AIS.  
> Например: ?WATCH={"subscribe":"TPV,AIS"};  

> "dontUseDevices" - указывает, данные каких классов от каких устройств **gpsd** клиентская программа получать не желает.  
> Например: ?WATCH={"dontUseDevices":{"ATT":["gpsd://192.168.10.10:2947#tcp://localhost:2222"],"AIS":["tcp://192.168.10.10:3800"]}}  

> "enable" - true/false, включает/выключает получение данных  

**?POLL;**, **?POLL={};** Прекращает (возможно, действующий по подключению) режим **WATCH** и требует однократного получения данных. Параметры могут быть "subscribe" и "dontUseDevices". В отличии от собственно **gpsd**, по ?POLL={"subscribe":"AIS"}; можно получить данные AIS.

Любые другие команды и параметры протокола **gpsd** игнорируются. Команды можно посылать в любой момент в любом порядке.



## Поддержка
[Форум](https://github.com/VladimirKalachikhin/Galadriel-map/discussions)

Форум будет живее, если вы сделаете пожертвование на [ЮМани](https://sobe.ru/na/galadrielmap).

Вы можете получить [индивидуальную платную консультацию](https://kwork.ru/training-consulting/20093293/konsultatsii-po-ustanovke-i-ispolzovaniyu-galadrielmap) по использованию **gpsd2websocket**.

